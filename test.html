<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KnowmeLM - Apple 风格 UI 原型</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f5f5f7; /* 类似苹果的 systemGray6Color */
            color: #1d1d1f; /* 主要文本颜色 */
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .sf-symbol { /* 模拟 SF Symbol 风格 */
            display: inline-block;
            width: 1.25em;
            height: 1.25em;
            stroke-width: 1.5;
            fill: none;
            stroke: currentColor;
        }
        .sf-symbol-filled {
            fill: currentColor;
            stroke: none;
        }
        .capsule-button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.625rem 1.25rem; /* 10px 20px */
            border-radius: 9999px; /* 胶囊形状 */
            font-weight: 500;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
        }
        .capsule-button-primary {
            background-color: #007AFF; /* 苹果蓝 */
            color: white;
        }
        .capsule-button-primary:hover {
            background-color: #0056b3;
        }
        .capsule-button-secondary {
            background-color: #e9e9eb; /* 浅灰色背景 */
            color: #1d1d1f;
        }
        .capsule-button-secondary:hover {
            background-color: #dcdce0;
        }
        .icon-button {
            padding: 0.5rem; /* 8px */
            border-radius: 0.5rem; /* 8px */
            transition: background-color 0.2s ease-in-out;
        }
        .icon-button:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }
        .icon-button.active {
            background-color: #007AFF;
            color: white;
        }
        .pro-tag {
            display: inline-block;
            padding: 0.125rem 0.5rem; /* 2px 8px */
            font-size: 0.75rem; /* 12px */
            font-weight: 600;
            background-color: #007AFF; /* 强调色 */
            color: white;
            border-radius: 0.25rem; /* 4px */
            margin-left: 0.5rem; /* 8px */
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.4); /* 半透明黑色背景，模拟毛玻璃下的暗化效果 */
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            backdrop-filter: blur(4px); /* 毛玻璃效果 */
            -webkit-backdrop-filter: blur(4px);
        }
        .modal-content {
            background-color: #ffffff;
            border-radius: 0.75rem; /* 12px */
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04);
            padding: 2rem; /* 32px */
            width: 90%;
            max-width: 600px; /* 限制最大宽度 */
        }
        .nav-item-text {
             margin-left: 0.375rem; /* 6px */
        }
        .hidden {
            display: none !important;
        }
        .page-transition {
            animation: fadeIn 0.3s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .dropdown-menu {
            position: absolute;
            background-color: white;
            border-radius: 0.5rem; /* 8px */
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
            z-index: 10;
            min-width: 160px; /* 最小宽度 */
            padding: 0.5rem 0; /* 8px 上下内边距 */
        }
        .dropdown-menu-item {
            display: block;
            padding: 0.5rem 1rem; /* 8px 16px */
            color: #1d1d1f;
            font-size: 0.875rem; /* 14px */
            white-space: nowrap;
        }
        .dropdown-menu-item:hover {
            background-color: #f0f0f0; /* 悬停背景色 */
        }
    </style>
</head>
<body class="min-h-screen">

    <div id="appContainer" class="w-full h-full">

        <div id="dashboardPage" class="page page-transition">
            <header class="bg-white/80 backdrop-blur-md sticky top-0 z-40 border-b border-gray-200">
                <div class="max-w-screen-xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="flex items-center justify-between h-16">
                        <div class="flex items-center">
                            <svg class="sf-symbol text-blue-600 h-8 w-8 mr-2" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13h2v6h-2zm0 8h2v2h-2z"></path>
                            </svg>
                            <span class="font-semibold text-xl text-gray-800">KnowmeLM</span>
                        </div>
                        <div class="flex items-center space-x-4">
                            <button class="flex items-center text-gray-600 hover:text-blue-600 transition-colors">
                                <svg class="sf-symbol h-5 w-5" viewBox="0 0 20 20" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.532 1.532 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.532 1.532 0 01-.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd"></path></svg>
                                <span class="nav-item-text hidden sm:inline">设置</span>
                            </button>
                            <span class="pro-tag">PRO</span>
                            <div class="relative">
                                <button id="userAvatarButtonDashboard" class="focus:outline-none">
                                    <img class="h-8 w-8 rounded-full object-cover" src="https://placehold.co/40x40/E2E8F0/A0AEC0?text=U" alt="用户头像">
                                </button>
                                <div id="userMenuDashboard" class="dropdown-menu hidden origin-top-right right-0 mt-2">
                                    <a href="#" class="dropdown-menu-item">账户管理</a>
                                    <a href="#" class="dropdown-menu-item">偏好设置</a>
                                    <a href="#" class="dropdown-menu-item text-red-600">退出登录</a>
                                 </div>
                            </div>
                        </div>
                    </div>
                </div>
            </header>

            <main class="max-w-screen-xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                <h1 class="text-3xl font-semibold text-gray-900 mb-6">欢迎使用 KnowmeLM</h1>

                <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-6 space-y-4 sm:space-y-0">
                    <button id="navigateToNotebookNew" class="capsule-button capsule-button-primary">
                        <svg class="sf-symbol h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"></path></svg>
                        新建
                    </button>

                    <div class="flex items-center space-x-3">
                        <div class="flex items-center space-x-1 p-1 bg-gray-200 rounded-lg">
                            <button class="icon-button p-1.5 sm:p-2">
                                <svg class="sf-symbol h-5 w-5" viewBox="0 0 20 20" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M5 3a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2V5a2 2 0 00-2-2H5zM5 11a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2v-2a2 2 0 00-2-2H5zM11 5a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V5zM11 13a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path></svg>
                            </button>
                            <button class="icon-button active p-1.5 sm:p-2">
                                <svg class="sf-symbol h-5 w-5" viewBox="0 0 20 20" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"></path></svg>
                            </button>
                        </div>
                        <div class="relative">
                            <button id="sortButton" class="flex items-center text-sm text-gray-600 bg-gray-200 hover:bg-gray-300 px-3 py-1.5 rounded-md transition-colors">
                                最近
                                <svg class="sf-symbol h-4 w-4 ml-1 text-gray-500" viewBox="0 0 20 20" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                            </button>
                            <div id="sortMenu" class="dropdown-menu hidden origin-top-right right-0 mt-2">
                                <a href="#" class="dropdown-menu-item">最近</a>
                                <a href="#" class="dropdown-menu-item">按标题</a>
                                <a href="#" class="dropdown-menu-item">创建日期</a>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white shadow-sm rounded-lg overflow-hidden">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"></th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">标题</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider hidden sm:table-cell">来源数量</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider hidden md:table-cell">创建时间</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider hidden lg:table-cell">角色</th>
                                <th scope="col" class="relative px-6 py-3">
                                    <span class="sr-only">操作</span>
                                </th>
                            </tr>
                        </thead>
                        <tbody id="notebooksTableBody" class="bg-white divide-y divide-gray-200">
                            <!-- Notebook rows will be dynamically inserted here -->
                        </tbody>
                    </table>
                </div>
            </main>
        </div>

        <div id="notebookPage" class="page hidden page-transition">
            <header class="bg-white/80 backdrop-blur-md sticky top-0 z-40 border-b border-gray-200">
                <div class="max-w-screen-2xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="flex items-center justify-between h-16">
                        <div class="flex items-center">
                            <button id="backToDashboard" class="p-2 rounded-md hover:bg-gray-200 mr-2">
                                 <svg class="sf-symbol h-5 w-5 text-gray-600" viewBox="0 0 20 20" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>
                            </button>
                            <input type="text" id="notebookTitleInput" value="Untitled notebook" class="text-lg font-medium text-gray-800 bg-transparent focus:outline-none focus:ring-1 focus:ring-blue-500 rounded-md px-2 py-1 -ml-2">
                        </div>
                        <div class="flex items-center space-x-2 md:space-x-3">
                            <button class="flex items-center text-sm text-gray-600 hover:text-blue-600 transition-colors px-2 py-1.5 rounded-md hover:bg-gray-100">
                                <svg class="sf-symbol h-5 w-5" viewBox="0 0 20 20" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M3 3a1 1 0 000 2v8a2 2 0 002 2h2.586l-1.293 1.293a1 1 0 101.414 1.414L10 15.414l2.293 2.293a1 1 0 001.414-1.414L12.414 15H15a2 2 0 002-2V5a1 1 0 100-2H3zm11 4a1 1 0 10-2 0v4a1 1 0 102 0V7zm-3 1a1 1 0 10-2 0v3a1 1 0 102 0V8zm-4-1a1 1 0 00-1 1v2a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>
                                <span class="nav-item-text hidden sm:inline">分析</span>
                            </button>
                            <button class="flex items-center text-sm text-gray-600 hover:text-blue-600 transition-colors px-2 py-1.5 rounded-md hover:bg-gray-100">
                                <span class="relative flex h-2 w-2 mr-1.5">
                                  <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span>
                                  <span class="relative inline-flex rounded-full h-2 w-2 bg-red-500"></span>
                                </span>
                                <span class="hidden sm:inline">新功能!</span><span class="nav-item-text">公开共享</span>
                            </button>
                             <button class="flex items-center text-sm text-gray-600 hover:text-blue-600 transition-colors px-2 py-1.5 rounded-md hover:bg-gray-100">
                                <svg class="sf-symbol h-5 w-5" viewBox="0 0 20 20" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M15 8a3 3 0 10-2.977-2.63l-4.94 2.47a3 3 0 100 4.319l4.94 2.47a3 3 0 10.895-1.789l-4.94-2.47a3.027 3.027 0 000-.74l4.94-2.47C13.456 7.68 14.19 8 15 8z"></path></svg>
                                <span class="nav-item-text hidden sm:inline">分享</span>
                            </button>
                            <button class="flex items-center text-gray-600 hover:text-blue-600 transition-colors px-2 py-1.5 rounded-md hover:bg-gray-100">
                                <svg class="sf-symbol h-5 w-5" viewBox="0 0 20 20" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.532 1.532 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.532 1.532 0 01-.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd"></path></svg>
                                <span class="nav-item-text hidden sm:inline">设置</span>
                            </button>
                            <span class="pro-tag">PRO</span>
                             <div class="relative">
                                <button id="userAvatarButtonNotebook" class="focus:outline-none">
                                    <img class="h-8 w-8 rounded-full object-cover" src="https://placehold.co/40x40/E2E8F0/A0AEC0?text=U" alt="用户头像">
                                </button>
                                <div id="userMenuNotebook" class="dropdown-menu hidden origin-top-right right-0 mt-2">
                                    <a href="#" class="dropdown-menu-item">账户管理</a>
                                    <a href="#" class="dropdown-menu-item">偏好设置</a>
                                    <a href="#" class="dropdown-menu-item text-red-600">退出登录</a>
                                 </div>
                            </div>
                        </div>
                    </div>
                </div>
            </header>

            <div class="max-w-screen-2xl mx-auto px-4 sm:px-6 lg:px-8 py-6 grid grid-cols-1 md:grid-cols-12 gap-6 h-[calc(100vh-4rem-3rem)]">
                <aside class="md:col-span-3 lg:col-span-3 bg-white p-5 rounded-lg shadow-sm flex flex-col h-full">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">来源</h2>
                    <div class="flex space-x-2 mb-4">
                        <button id="openAddSourceModal" class="capsule-button capsule-button-primary flex-1">
                            <svg class="sf-symbol h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"></path></svg>
                            添加
                        </button>
                        <button class="capsule-button capsule-button-secondary flex-1">
                           <svg class="sf-symbol h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"></path></svg>
                            探索
                        </button>
                    </div>
                    <div class="flex-grow flex flex-col items-center justify-center text-center text-gray-500 border-2 border-dashed border-gray-300 rounded-md p-6">
                        <svg class="sf-symbol h-16 w-16 text-gray-400 mb-4" viewBox="0 0 24 24" stroke-width="1" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                           <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                           <path d="M9 4h3l2 2h5a2 2 0 0 1 2 2v7a2 2 0 0 1 -2 2h-10a2 2 0 0 1 -2 -2v-9a2 2 0 0 1 2 -2"></path>
                           <path d="M12 11v6"></path>
                           <path d="M9 14h6"></path>
                        </svg>
                        <p class="text-sm">暂无来源</p>
                        <p class="text-xs mt-1">点击"添加"以上传文件</p>
                    </div>
                </aside>

                <main class="md:col-span-6 lg:col-span-6 bg-white p-5 rounded-lg shadow-sm flex flex-col h-full">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">对话</h2>
                    <div id="chatBox" class="flex-grow border border-gray-300 rounded-md p-4 mb-4 overflow-y-auto flex flex-col space-y-4">
                        <div class="flex items-start">
                            <img class="h-8 w-8 rounded-full object-cover mr-3" src="https://placehold.co/40x40/E2E8F0/A0AEC0?text=U" alt="用户头像">
                            <div class="bg-blue-100 p-3 rounded-lg max-w-[80%]">
                                <p class="text-sm text-gray-800">你好！请上传来源文件来开始对话。</p>
                            </div>
                        </div>
                    </div>
                    <div class="mt-auto flex items-center space-x-3">
                        <textarea id="chatInput" class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-shadow resize-none" rows="3" placeholder="向您的来源提问... (0 个来源已添加)"></textarea>
                        <button id="sendMessageButton" class="capsule-button capsule-button-primary self-end p-3">
                            <svg class="sf-symbol h-5 w-5" viewBox="0 0 20 20" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z"></path></svg>
                        </button>
                    </div>
                </main>

                <aside class="md:col-span-3 lg:col-span-3 bg-white p-5 rounded-lg shadow-sm flex flex-col h-full space-y-6 overflow-y-auto">
                    <h2 class="text-xl font-semibold text-gray-800">Studio</h2>
                    
                    <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                        <div class="flex items-start space-x-3">
                            <svg class="sf-symbol h-6 w-6 text-blue-600 mt-1" viewBox="0 0 20 20" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path></svg>
                            <div>
                                <h3 class="text-md font-medium text-gray-800">概览</h3>
                                <p class="text-sm text-gray-600 mt-1">快速了解您的来源内容精华。</p>
                                <a href="#" class="text-sm text-blue-600 hover:text-blue-800 font-medium mt-2 inline-block">了解详情 &rarr;</a>
                            </div>
                        </div>
                    </div>

                    <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                        <h3 class="text-md font-medium text-gray-800 mb-3">深入研究</h3>
                        <div class="space-y-2">
                            <button class="w-full capsule-button capsule-button-secondary text-sm">
                                <svg class="sf-symbol h-4 w-4 mr-2" viewBox="0 0 20 20" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M5 4a1 1 0 00-2 0v7.268a2 2 0 000 3.464V16a1 1 0 102 0v-1.268a2 2 0 000-3.464V4zM11 4a1 1 0 10-2 0v1.268a2 2 0 000 3.464V16a1 1 0 102 0V8.732a2 2 0 000-3.464V4zM16 3a1 1 0 011 1v7.268a2 2 0 010 3.464V16a1 1 0 11-2 0v-1.268a2 2 0 010-3.464V4a1 1 0 011-1z"></path></svg>
                                自定义
                            </button>
                            <button class="w-full capsule-button capsule-button-primary text-sm">
                                <svg class="sf-symbol h-4 w-4 mr-2" viewBox="0 0 20 20" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M11.3 1.046A1 1 0 0112 2v1.993l1.175-.39a1 1 0 011.247 1.247L13.993 6H16a1 1 0 011 1v1.303l.954 1.175a1 1 0 01-.247 1.618l-1.302.39V12a1 1 0 01-1.046.954L14 12.825V14a1 1 0 01-1.993.175l-.39-1.175a1 1 0 01-1.247-1.247L12 10.007V8a1 1 0 01-.954-1.046L11.175 6H10a1 1 0 01-.175-1.993l1.175-.39a1 1 0 011.247-1.247L12 3.993V2a1 1 0 01.954-.954L11.3 1.046zm-2.6 3.047a1 1 0 011.247 1.247L9.553 6H10a1 1 0 01.825 1.993l-.39 1.175a1 1 0 01-1.247 1.247L8 10.007V10a1 1 0 01-1-1V8a1 1 0 01.954-1.046L8.825 6H8a1 1 0 01-.175-1.993l1.175-.39zM2 6a1 1 0 011-1h1.993l.39-1.175a1 1 0 011.247-1.247L8 1.993V2a1 1 0 011.954-.954L8.7 1.046A1 1 0 018 0a1 1 0 01-.954.046L6.007 1.22l-1.175.39A1 1 0 013.585 3.02L3.975 4H2a1 1 0 01-1 .954L1.175 6H2zm0 0v1.993l-.39 1.175a1 1 0 01-1.247 1.247L1.993 12H2a1 1 0 01.954 1.046L2.825 14H4a1 1 0 01.175 1.993l-1.175.39a1 1 0 01-1.247-1.247L2.007 14H2a1 1 0 01-1.046-.954L1 12.825V12a1 1 0 011.993-.175l.39 1.175a1 1 0 011.247 1.247L6 14.007V14a1 1 0 011 1h.303l1.175.954a1 1 0 01-.247 1.618l-1.302.39V18a1 1 0 01-1.046.954L6 18.825V20a1 1 0 01-1.993-.175l-.39-1.175a1 1 0 01-1.247-1.247L4 16.007V16a1 1 0 01-1-1v-.303l-.954-1.175a1 1 0 01.247-1.618l1.302-.39V12a1 1 0 011.046-.954L6 11.175V10a1 1 0 011.993.175l.39 1.175a1 1 0 011.247 1.247L10 14.007V14a1 1 0 011 1h.303l1.175.954a1 1 0 01-.247 1.618l-1.302.39V18a1 1 0 01-1.046.954L10 18.825V20a1 1 0 01-1.993-.175l-.39-1.175a1 1 0 01-1.247-1.247L8 16.007V16a1 1 0 01-1-1v-.303l-.954-1.175a1 1 0 01.247-1.618l1.302-.39V12a1 1 0 011.046-.954L8 11.175V10a1 1 0 011-1h.303L10.415 8l-1.175-.954A1 1 0 018.993 6H8a1 1 0 01-1-1V4a1 1 0 01.954-1.046L8.825 2H8a1 1 0 01-.175-1.993l1.175-.39a1 1 0 011.247 1.247L10.007 2H10a1 1 0 011 1v.303l.954 1.175a1 1 0 01-.247 1.618L10.415 6H10a1 1 0 01-1-1V4a1 1 0 01.954-1.046L10.825 2H10a1 1 0 01-.175-1.993l1.175-.39a1 1 0 011.247 1.247L12.007 2H12a1 1 0 011 1v.303l.954 1.175a1 1 0 01-.247 1.618L12.415 6H12a1 1 0 01-1-1V4a1 1 0 01.954-1.046L11.825 2H12a1 1 0 01.825 1.993l-.39 1.175A1 1 0 0111.188 6L10 5.557V6a1 1 0 01-1 1H8.697L7.522 8.175A1 1 0 017.275 9.793l.39 1.302V12a1 1 0 01-.954 1.046L6.825 14H8a1 1 0 01.175 1.993l-1.175.39a1 1 0 01-1.247-1.247L6.007 14H6a1 1 0 01-1-1v-.303l-.954-1.175a1 1 0 01.247-1.618L5.585 10H6a1 1 0 011-1V8.697l1.175-1.175A1 1 0 019.793 7.275l1.302-.39V6a1 1 0 011.046-.954z" clip-rule="evenodd"></path></svg>
                                生成
                            </button>
                        </div>
                    </div>

                    <div class="flex-grow flex flex-col">
                        <h3 class="text-md font-medium text-gray-800 mb-3">备注</h3>
                        <div class="flex flex-wrap gap-2 mb-3">
                            <button class="text-xs bg-blue-100 text-blue-700 hover:bg-blue-200 px-2.5 py-1 rounded-full transition-colors">学习指南</button>
                            <button class="text-xs bg-green-100 text-green-700 hover:bg-green-200 px-2.5 py-1 rounded-full transition-colors">简报文档</button>
                            <button class="text-xs bg-purple-100 text-purple-700 hover:bg-purple-200 px-2.5 py-1 rounded-full transition-colors">会议纪要</button>
                        </div>
                        <div class="flex-grow border border-gray-300 rounded-lg p-3">
                            <textarea id="notebookNotesTextarea" class="w-full h-full text-sm text-gray-700 focus:outline-none resize-none" placeholder="在此处键入您的笔记..."></textarea>
                        </div>
                    </div>

                </aside>
            </div>
            <footer class="text-center py-4 border-t border-gray-200 bg-white">
                <p class="text-xs text-gray-500">&copy; 2024 KnowmeLM. 保留所有权利。</p>
            </footer>
        </div>

        <div id="addSourceModal" class="modal-overlay hidden page-transition">
            <div class="modal-content w-full max-w-lg relative">
                <button id="closeAddSourceModal" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                    <svg class="sf-symbol h-6 w-6" viewBox="0 0 20 20" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                </button>

                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-semibold text-gray-900">添加来源</h2>
                    <button class="capsule-button capsule-button-secondary text-sm">
                        <svg class="sf-symbol h-4 w-4 mr-2" viewBox="0 0 20 20" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"></path></svg>
                        探索来源
                    </button>
                </div>

                <div class="mb-6">
                    <p class="text-gray-700 mb-1">添加来源后，KnowmeLM 能够基于这些对您最重要的信息提供回答。</p>
                    <p class="text-sm text-gray-500">(示例: 营销方案、课程阅读材料、研究笔记、会议转写内容、销售文档等)</p>
                </div>

                <div id="dropZone" class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center cursor-pointer hover:border-blue-500 transition-colors">
                    <svg class="sf-symbol h-12 w-12 text-blue-500 mx-auto mb-4" viewBox="0 0 24 24" stroke-width="1" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                       <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                       <path d="M7 18a4.6 4.4 0 0 1 0 -9a5 4.5 0 0 1 11 2h1a3.5 3.5 0 0 1 0 7h-1"></path>
                       <path d="M9 15l3 -3l3 3"></path>
                       <path d="M12 12v9"></path>
                    </svg>
                    <p class="text-lg font-medium text-gray-700 mb-1">上传来源</p>
                    <p class="text-sm text-gray-500">拖放或<span class="text-blue-600 font-medium">选择文件</span>, 即可上传</p>
                    <input type="file" id="fileInput" class="hidden" multiple>
                </div>
                 <div class="mt-2 text-center">
                    <p class="text-xs text-gray-500">支持的文件类型: PDF, .txt, Markdown, 音频 (例如 mp3)</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Notebook structure: { id: string, title: string, notes: string, createdAt: string }
        let currentNotebookId = null;
        const savedNotebookId = sessionStorage.getItem('currentNotebookId');
        if (savedNotebookId) {
            currentNotebookId = savedNotebookId;
        }

        function generateNotebookId() {
            return `notebook-${Date.now()}`;
        }

        function getNotebooks() {
            try {
                const notebooksJson = localStorage.getItem('notebooks');
                if (notebooksJson) {
                    return JSON.parse(notebooksJson);
                }
            } catch (error) {
                console.error("Error getting notebooks from localStorage:", error);
            }
            return [];
        }

        function saveNotebooks(notebooksArray) {
            try {
                localStorage.setItem('notebooks', JSON.stringify(notebooksArray));
            } catch (error) {
                console.error("Error saving notebooks to localStorage:", error);
            }
        }

        function getNotebookById(id) {
            const notebooks = getNotebooks();
            return notebooks.find(notebook => notebook.id === id);
        }

        function addNotebook(notebookObject) {
            const notebooks = getNotebooks();
            notebooks.push(notebookObject);
            saveNotebooks(notebooks);
        }

        function updateNotebook(updatedNotebook) {
            const notebooks = getNotebooks();
            const index = notebooks.findIndex(notebook => notebook.id === updatedNotebook.id);
            if (index !== -1) {
                notebooks[index] = updatedNotebook;
                saveNotebooks(notebooks);
                return true;
            }
            return false;
        }

        // 页面导航和通用交互逻辑
        const dashboardPage = document.getElementById('dashboardPage');
        const notebookPage = document.getElementById('notebookPage');
        const addSourceModal = document.getElementById('addSourceModal');

        const navigateToNotebookNew = document.getElementById('navigateToNotebookNew');
        const navigateToNotebookExisting = document.getElementById('navigateToNotebookExisting'); // Example for existing item
        const backToDashboard = document.getElementById('backToDashboard');
        
        const openAddSourceModalButton = document.getElementById('openAddSourceModal');
        const closeAddSourceModalButton = document.getElementById('closeAddSourceModal');
        const uploadSourceFromChatButton = document.getElementById('uploadSourceFromChat');

        const userAvatarButtonDashboard = document.getElementById('userAvatarButtonDashboard');
        const userMenuDashboard = document.getElementById('userMenuDashboard');
        const userAvatarButtonNotebook = document.getElementById('userAvatarButtonNotebook');
        const userMenuNotebook = document.getElementById('userMenuNotebook');
        const sortButton = document.getElementById('sortButton');
        const sortMenu = document.getElementById('sortMenu');

        function showPage(pageElement) {
            dashboardPage.classList.add('hidden');
            notebookPage.classList.add('hidden');
            if (pageElement) {
                pageElement.classList.remove('hidden');
                pageElement.classList.add('page-transition');
                if (pageElement.id === 'dashboardPage') {
                    renderDashboardNotebooks();
                } else if (pageElement.id === 'notebookPage') {
                    loadNotebookDataToPage();
                }
            }
        }

        function loadNotebookDataToPage() {
            const titleInput = document.getElementById('notebookTitleInput');
            const notesTextarea = document.getElementById('notebookNotesTextarea');

            if (!titleInput || !notesTextarea) {
                console.error("Notebook title input or notes textarea not found");
                return;
            }

            if (currentNotebookId) {
                const notebook = getNotebookById(currentNotebookId);
                if (notebook) {
                    titleInput.value = notebook.title;
                    notesTextarea.value = notebook.notes;
                } else {
                    console.warn("Current notebook not found in localStorage. ID:", currentNotebookId);
                    titleInput.value = "Untitled Notebook";
                    notesTextarea.value = "";
                }
            } else {
                // Default state if no notebook is active (e.g., direct navigation or error)
                titleInput.value = "Untitled Notebook";
                notesTextarea.value = "";
                console.log("No currentNotebookId set. Displaying default state for notebook page.");
            }
        }

        function saveCurrentNotebookData() {
            if (!currentNotebookId) {
                // console.warn("No currentNotebookId set. Cannot save data.");
                // This can happen if user types before a notebook is formally created/loaded
                // Or if they navigate to the page directly without an active notebook.
                // For now, we won't create a new notebook here, just prevent saving.
                return;
            }

            const notebook = getNotebookById(currentNotebookId);
            if (notebook) {
                const titleInput = document.getElementById('notebookTitleInput');
                const notesTextarea = document.getElementById('notebookNotesTextarea');
                
                notebook.title = titleInput.value;
                notebook.notes = notesTextarea.value;
                
                if (updateNotebook(notebook)) {
                    // console.log("Notebook data saved for ID:", currentNotebookId);
                } else {
                    // console.error("Failed to save notebook data for ID:", currentNotebookId);
                }
            } else {
                // console.warn("Could not find notebook to save. ID:", currentNotebookId);
            }
        }


        function renderDashboardNotebooks() {
            const notebooksTableBody = document.getElementById('notebooksTableBody');
            if (!notebooksTableBody) return;

            const notebooks = getNotebooks();
            notebooksTableBody.innerHTML = ''; // Clear existing rows

            if (notebooks.length === 0) {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td colspan="6" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">No notebooks yet. Click '新建' to create one.</td>`;
                notebooksTableBody.appendChild(tr);
            } else {
                notebooks.forEach(notebook => {
                    const tr = document.createElement('tr');
                    tr.classList.add('hover:bg-gray-50', 'transition-colors', 'group');
                    
                    // Icon
                    const iconTd = document.createElement('td');
                    iconTd.classList.add('px-6', 'py-4', 'whitespace-nowrap');
                    iconTd.innerHTML = `<svg class="sf-symbol h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M9 4.804A7.968 7.968 0 005.5 4c-1.255 0-2.443.29-3.5.804v10A7.969 7.969 0 015.5 16c1.669 0 3.218-.51 4.5-1.385A7.962 7.962 0 0114.5 16c1.255 0 2.443-.29 3.5-.804v-10A7.968 7.968 0 0014.5 4c-1.255 0-2.443.29-3.5.804V12a1 1 0 11-2 0V4.804z"></path></svg>`;
                    tr.appendChild(iconTd);

                    // Title
                    const titleTd = document.createElement('td');
                    titleTd.classList.add('px-6', 'py-4', 'whitespace-nowrap');
                    const titleDiv = document.createElement('div');
                    titleDiv.classList.add('text-sm', 'font-medium', 'text-blue-600', 'hover:text-blue-800', 'cursor-pointer', 'notebook-link');
                    titleDiv.textContent = notebook.title;
                    titleDiv.setAttribute('data-notebook-id', notebook.id);
                    // titleDiv.addEventListener('click', () => { /* Navigate to notebook page, implemented later */ });
                    titleTd.appendChild(titleDiv);
                    tr.appendChild(titleTd);

                    // Source count
                    const sourcesTd = document.createElement('td');
                    sourcesTd.classList.add('px-6', 'py-4', 'whitespace-nowrap', 'text-sm', 'text-gray-500', 'hidden', 'sm:table-cell');
                    sourcesTd.textContent = `${notebook.sources ? notebook.sources.length : 0} Sources`;
                    tr.appendChild(sourcesTd);

                    // Creation date
                    const dateTd = document.createElement('td');
                    dateTd.classList.add('px-6', 'py-4', 'whitespace-nowrap', 'text-sm', 'text-gray-500', 'hidden', 'md:table-cell');
                    dateTd.textContent = new Date(notebook.createdAt).toLocaleDateString();
                    tr.appendChild(dateTd);

                    // Role
                    const roleTd = document.createElement('td');
                    roleTd.classList.add('px-6', 'py-4', 'whitespace-nowrap', 'text-sm', 'text-gray-500', 'hidden', 'lg:table-cell');
                    roleTd.textContent = 'Owner'; // Placeholder
                    tr.appendChild(roleTd);

                    // Actions
                    const actionsTd = document.createElement('td');
                    actionsTd.classList.add('px-6', 'py-4', 'whitespace-nowrap', 'text-right', 'text-sm', 'font-medium');
                    actionsTd.innerHTML = `
                        <div class="relative">
                            <button class="text-gray-400 hover:text-gray-600 opacity-0 group-hover:opacity-100 transition-opacity focus:opacity-100 more-actions-button" data-notebook-id="${notebook.id}">
                                <svg class="sf-symbol h-5 w-5" viewBox="0 0 20 20" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z"></path></svg>
                            </button>
                            <div class="dropdown-menu hidden origin-top-right right-0 mt-2 more-actions-menu">
                                <a href="#" class="dropdown-menu-item rename-notebook-button" data-notebook-id="${notebook.id}">重命名</a>
                                <a href="#" class="dropdown-menu-item share-notebook-button" data-notebook-id="${notebook.id}">分享</a>
                                <a href="#" class="dropdown-menu-item text-red-600 delete-notebook-button" data-notebook-id="${notebook.id}">删除</a>
                            </div>
                        </div>`;
                    tr.appendChild(actionsTd);
                    
                    notebooksTableBody.appendChild(tr);
                });
                // Re-initialize dropdowns for the newly added "more-actions-button"
                document.querySelectorAll('.more-actions-button').forEach(button => {
                    const menu = button.nextElementSibling;
                    if (!button.dataset.dropdownInitialized) { // Avoid re-attaching listeners
                        setupDropdown(button, menu);
                        button.dataset.dropdownInitialized = true;
                    }
                });
            }
        }


        function toggleModal(modalElement, show) {
            if (show) {
                modalElement.classList.remove('hidden');
                modalElement.classList.add('page-transition');
                 // Prevent body scroll when modal is open
                document.body.style.overflow = 'hidden';
            } else {
                modalElement.classList.add('hidden');
                document.body.style.overflow = ''; // Restore body scroll
            }
        }
        
        // 导航逻辑
        if (navigateToNotebookNew) {
            navigateToNotebookNew.addEventListener('click', () => {
                const newNotebookId = generateNotebookId();
                const newNotebook = {
                    id: newNotebookId,
                    title: "Untitled Notebook " + new Date().toLocaleDateString(),
                    notes: "",
                    createdAt: new Date().toISOString(),
                    sources: [], // Initialize with empty sources
                    chatHistory: [] // Initialize with empty chat history
                };
                addNotebook(newNotebook);
                currentNotebookId = newNotebookId;
                sessionStorage.setItem('currentNotebookId', currentNotebookId);
                // Potentially load this notebook's data into notebookPage elements here
                showPage(notebookPage);
            });
        }
        if (navigateToNotebookExisting) {
             navigateToNotebookExisting.addEventListener('click', () => showPage(notebookPage));
        }
        if (backToDashboard) {
            backToDashboard.addEventListener('click', () => showPage(dashboardPage));
        }

        // 添加来源模态框逻辑
        if (openAddSourceModalButton) {
            openAddSourceModalButton.addEventListener('click', () => toggleModal(addSourceModal, true));
        }
        if (closeAddSourceModalButton) {
            closeAddSourceModalButton.addEventListener('click', () => toggleModal(addSourceModal, false));
        }
        if (uploadSourceFromChatButton) { // "上传来源" from chat panel
            uploadSourceFromChatButton.addEventListener('click', () => toggleModal(addSourceModal, true));
        }
         // Close modal if clicked outside of modal-content
        if (addSourceModal) {
            addSourceModal.addEventListener('click', (event) => {
                if (event.target === addSourceModal) { // Clicked on overlay
                    toggleModal(addSourceModal, false);
                }
            });
        }


        // 文件拖放区逻辑
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');

        if (dropZone) {
            dropZone.addEventListener('click', () => fileInput.click());

            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('border-blue-500', 'bg-blue-50');
            });

            dropZone.addEventListener('dragleave', () => {
                dropZone.classList.remove('border-blue-500', 'bg-blue-50');
            });

            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('border-blue-500', 'bg-blue-50');
                const files = e.dataTransfer.files;
                if (files.length) {
                    fileInput.files = files;
                    // Handle file upload logic here
                    console.log('Files dropped:', files);
                    alert(files.length + ' 个文件已选择。实际上传逻辑未实现。');
                }
            });
        }
        if (fileInput) {
             fileInput.addEventListener('change', (e) => {
                const files = e.target.files;
                 if (files.length) {
                    // Handle file upload logic here
                    console.log('Files selected:', files);
                    alert(files.length + ' 个文件已选择。实际上传逻辑未实现。');
                }
            });
        }

        // 下拉菜单通用逻辑
        function setupDropdown(button, menu) {
            if (!button || !menu) return;
            button.addEventListener('click', (event) => {
                event.stopPropagation(); // Prevent click from bubbling to document
                menu.classList.toggle('hidden');
            });
        }
        
        setupDropdown(userAvatarButtonDashboard, userMenuDashboard);
        setupDropdown(userAvatarButtonNotebook, userMenuNotebook);
        setupDropdown(sortButton, sortMenu);

        // "更多操作" 下拉菜单 (列表项)
        document.querySelectorAll('.more-actions-button').forEach(button => {
            const menu = button.nextElementSibling; // Assumes menu is the next sibling
            setupDropdown(button, menu);
        });

        // 点击页面其他地方关闭打开的下拉菜单
        document.addEventListener('click', (event) => {
            const openMenus = document.querySelectorAll('.dropdown-menu:not(.hidden)');
            openMenus.forEach(menu => {
                // Check if the click was outside the menu and its button
                const buttonId = menu.id.replace('Menu', 'Button'); // Heuristic to find related button
                const relatedButton = document.getElementById(buttonId) || menu.previousElementSibling; // Fallback for more-actions
                
                if (!menu.contains(event.target) && relatedButton && !relatedButton.contains(event.target)) {
                     menu.classList.add('hidden');
                }
            });
        });


        // Initial page load logic
        if (currentNotebookId) {
            const activeNotebook = getNotebookById(currentNotebookId);
            if (activeNotebook) {
                showPage(notebookPage); // Load notebook page if a valid current ID exists
            } else {
                // If ID from session is invalid (e.g. notebook deleted elsewhere)
                currentNotebookId = null; 
                sessionStorage.removeItem('currentNotebookId');
                showPage(dashboardPage); // Fallback to dashboard
            }
        } else {
            showPage(dashboardPage); // Default to dashboard if no current ID
        }

        // Event listener for navigating to existing notebooks from dashboard
        const notebooksTableBody = document.getElementById('notebooksTableBody');
        if (notebooksTableBody) {
            notebooksTableBody.addEventListener('click', (event) => {
                const notebookLink = event.target.closest('.notebook-link');
                if (notebookLink) {
                    const notebookId = notebookLink.getAttribute('data-notebook-id');
                    if (notebookId) {
                        currentNotebookId = notebookId;
                        sessionStorage.setItem('currentNotebookId', currentNotebookId);
                        showPage(notebookPage);
                    }
                }
            });
        }

        // Event listeners for saving notebook title and notes
        const notebookTitleInput = document.getElementById('notebookTitleInput');
        const notebookNotesTextarea = document.getElementById('notebookNotesTextarea');

        if (notebookTitleInput) {
            notebookTitleInput.addEventListener('input', saveCurrentNotebookData);
        }
        if (notebookNotesTextarea) {
            notebookNotesTextarea.addEventListener('input', saveCurrentNotebookData);
        }

        // 新增：聊天逻辑
        const chatInput = document.getElementById('chatInput');
        const sendMessageButton = document.getElementById('sendMessageButton');
        const chatBox = document.getElementById('chatBox'); // 获取聊天框元素

        // 函数：添加消息到聊天框
        function addMessage(text, isUser = false) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('flex', isUser ? 'justify-end' : 'items-start');

            const avatarUrl = isUser ? 'https://placehold.co/40x40/A0AEC0/E2E8F0?text=You' : 'https://placehold.co/40x40/E2E8F0/A0AEC0?text=AI'; // 示例头像
            const avatarAlt = isUser ? '用户头像' : 'AI头像';

            messageElement.innerHTML = `
                ${!isUser ? `<img class="h-8 w-8 rounded-full object-cover mr-3" src="${avatarUrl}" alt="${avatarAlt}">` : ''}
                <div class="${isUser ? 'bg-blue-500 text-white' : 'bg-gray-100 text-gray-800'} p-3 rounded-lg max-w-[80%]">
                    <p class="text-sm">${text}</p>
                </div>
                ${isUser ? `<img class="h-8 w-8 rounded-full object-cover ml-3" src="${avatarUrl}" alt="${avatarAlt}">` : ''}
            `;
             chatBox.appendChild(messageElement);
             // 滚动到底部
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        // 发送消息函数
        async function sendMessage() {
            const message = chatInput.value.trim();
            if (!message) return; // 不发送空消息

            addMessage(message, true); // 添加用户消息到聊天框
            chatInput.value = ''; // 清空输入框

            // 调用后端 API
            try {
                const response = await fetch('/chat', { // 假设后端运行在同一域名的 /chat 路径
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ message: message })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                addMessage(data.response); // 添加 AI 回复到聊天框

            } catch (error) {
                console.error('发送消息失败:', error);
                addMessage('抱歉，发生了一个错误，无法获取回复。', false); // 显示错误消息
            }
        }

        // 绑定事件监听器
        if (sendMessageButton) {
            sendMessageButton.addEventListener('click', sendMessage);
        }

        // 允许按 Enter 键发送 (同时按 Shift+Enter 换行)
        if (chatInput) {
            chatInput.addEventListener('keypress', (event) => {
                if (event.key === 'Enter' && !event.shiftKey) {
                    event.preventDefault(); // 阻止默认的换行行为
                    sendMessage();
                }
            });
        }
    </script>
</body>
</html>
